import requests
import csv
import os

KPI_LIST = ["U28112","U28113","U28116","U28118","U28119","U28120","U28121","U28122","U28123","U28124","U28125","U28126","U28127","U28128","U28129","U28130","U28131","U28132","U28133","U28134","U28135","U28136","U28137","U28138","U28139","U28140","U28141","U28142","U28143","U28144","U28145","U28146","N05015","N05019","N05405","N05406","N05701","N13008","N13014","N13020","N13028","N13029","N13030","N13031","N13800","N15001","N15027","N15058","N15425","N15426","N15427","N15428","N15472","N15473","N15507","N15508","N15544","N15545","N15546","N15828","N15829","N15830","N15831","N15835","N15901","N17528","U15011","U15015","N15008","N15031","N15034","N15053","N15419","N15433","N15434","N15435","N15436","N15452","N15454","N15482","N15485","N15488","N15505","N15513","N15514","N15515","N15516","N15561","N15564","N15567","N15569","N15570","N15571","N15572","N15573","N15574","N15575","N15576","N15601","N15602","N15603","N15604","N15605","N15606","N15613","N15615","N15618","N15623","N15629","N15631","N15632","N15633","N15634","N15635","N15636","N15643","N15645","N15648","N15653","N15659","N15809","N15810","N15814","N15820","N15821","N15822","N15823","N15902","U15457","U15459","U15461","N15032","N15035","N15420","N15429","N15430","N15431","N15432","N15451","N15453","N15481","N15484","N15487","N15506","N15517","N15518","N15519","N15520","N15562","N15565","N15568","N15815","N15824","N15825","N15826","N15903","N17007","N17444","N17451","N17452","N17453","N17459","N17467","N17479","N17480","N17481","N17531","N17624","N17661","N17662","N17663","N17665","N17666","N17673","N17675","N17678","N17683","N17689","N17691","N17814","N17817","N17820","N17826","N17831","N17832","N17833","N17837","N17839","N17841","N17902","N17941","N18621","U17446","U17448","U17449","U17802","U17808","N17443","N17454","N17460","N17470","N17482","N17535","N17690","N17815","N17818","N17821","N17827","N17834","N17835","N17836","N17838","N17840","N17842","N17903","N17942","N18631","U17415","U17417","U17419","N18019","N18021","N18027","N18706","N18707","N18708","N18709","N18710","N18711","N18803","N18890","N18034","N18712","N18713","N18714","N18715","N18716","N18717","N18718","N18804","U37001","U37002","U37003","U37004","U37005","U37006","U37008","U37009","N00053","N00072","N00090","N00098","N00200","N00201","N00203","N00204","N00205","N00206","N00207","N00208","N00209","N00210","N00211","N00214","N00219","N00223","N00227","N00230","N00232","N00233","N00234","N00235","N00236","N00237","N00238","N00239","N20035","N20041","N20200","N20201","N20203","N20204","N20205","N20206","N20207","N20208","N20209","N20210","N20211","N20214","N20222","N20230","N20234","N20237","N20239","N20240","N20241","N20242","N20243","N20244","N20245","N20246","N20801","N00564","N00667","N00905","N01951","N01958","N02907","N07001","N07900","N07901","N07902","N07903","N07904","N07907","N07908","N07909","N07910","N07911","N07912","N07913","N07917","N07923","N07924","N07925","N07926","N07927","N07928","N07929","N45022","U00958","U30446","U30464","U30465","N45029","N45923","U07414","U07480","U07481","U07486","U07487","U07488","U07489","U07490","U07491","U07492","U07493","U07494","U07495","U07496","U07801","N45900","N45901","N45904","N45905","N45910","N45911","N45912","N45913","N45914","N45920","N45925","N45926","N45927","N45928","N45933","N45934","N45970","N45971","N45972","N45973","N45974","N45975","N45976","N45977","N00401","N00403","N00404","N00712","N00752","N00754","N00892","N00914","N00923","N00925","N00927","N00938","N00943","N00945","N00952","N00998","N01982","N02243","N02797","N03702","N03926","N05401","N05816","N05825","N05831","N07401","N07403","N07410","N07418","N07549","N07700","N07701","N07702","N07713","N07806","N11800","N15638","N17461","N18741","N18961","N31816","N45930","N45932","N45941","N60111","N66077","N66078","N66079","N85051","N85052","N85053","N85055","N85056","N85057","N85069","U00501","U00502","U00915","U01405","U01413","U01420","U01425","U01429","U01473","U01760","U07451","U07514","U07917","U09800","U20462","U23584","U28532","U50125","N00570","N00571","N00575","N00599","N00600","N00601","N00602","N00603","N07005","N07016","N07804","N07805","N07821","N07822","U07425","U07426","U07427","U07428","U07456","U07457","U07458","U07497","U07498","U07499","U07500","U07501","N00125","N00126","N00903","N00926","N00999","N01004","N01006","N01724","N01960","N01963","N01994","N02100","N02101","N02102","N02201","N02202","N02203","N02205","N02206","N02208","N02210","N02212","N02214","N02216","N02218","N02220","N02222","N02224","N02226","N02228","N02231","N02233","N02235","N02237","N02239","N02241","N02251","N02252","N02267","N02274","N02276","N02279","N03002","N03007","N03920","N03921","N07905","N07906","N07915","N17445","N40003","N40009","N45700","N45702","N45703","N45850","N45851","N52001","N52002","N52003","N52004","U07446","U07447","U07448","U07449","U07450","U07455","U07459","U07508","U07509","U07510","U07511","U07512","U07513","U07552","N00669","N00951","N00973","N07402","N21704","N23801","N31814","N74811","U09808","U30750","U40455","N07037","N09018","N09022","N20892","N28892","N31807","U00587","U00588","U11001","U11404","U11901","U15010","U15401","U15900","U17001","U17401","U17900","U20008","U20404","U20900","U28001","U28408","U28900","U31002","U31401","U31904","N01952","N02908","N02952","N10801","N11008","N11024","N11041","N11044","N11047","N11050","N11053","N11056","N11060","N11061","N11102","N11103","N11701","N11704","N11710","N11711","N11802","N11808","N11811","N11010","N11032","N11033","N11043","N11046","N11049","N11052","N11055","N11058","N11104","N11703","N11706","N11810","N11813","U11200","U11530","U11531","U11532","U11533","U11534","U11535","U11536","U11537","U11538","U11539","U11540","U11541","U11542","U11543","U11544","U11545","N11011","N11042","N11045","N11048","N11051","N11054","N11057","N11105","N11702","N11705","N11809","N11812","N00510","N00517","N00750","N00751","N07788","N07803","N07935","N85047","N85048","N85054","N85084","N85500","N85501","U07524","U07525","U07526","U07527","U07528","U50122","U50128","N11005","N11803","N13060","N13061","N13062","N13063","N13064","N13065","N13066","N13067","N13068","N13700","N24010","N24011","N24012","N24013","N24014","N11732","N00300","N00301","N00302","N00303","N00304","N00305","N00306","N00307","N00308","N00309","N00310","N00366","N00370","N00371","N00372","N00373","N00713","N00799","N00971","N00997","N01983","N02268","N02994","N07530","N07531","N07536","N07537","N07538","N45909","N60910","N60920","N60984","N60986","N60987","N60988","N60989","U01402","U01404","U01407","U01411","U01414","U01423","U01435","U01803","U09804","U60423","U28518","U28519","U28520","U28521","U28522","U28523","U28524","U28560","U28574","U28575","U28576","U28577","U28578","U28579","U28580","U28581","U28582","U28583","U28584","U28585","U28586","U28587","U28641","U28642","U28643","U33964","U28525","U28526","U28527","U28528","U28529","U28530","U28531","U28571","U28588","U28589","U28590","U28591","U28592","U28593","U28594","U28595","U28596","U28597","U28598","U28599","U28600","U28601","U28644","U28645","U28646","U33966","U26482","U26483","U28533","U28534","U28535","U28536","U28537","U28538","U28561","U28562","U28602","U28603","U28604","U28605","U28606","U28607","U28608","U28609","U28610","U28611","U28612","U28613","U28614","U28615","U28647","U28648","U28658","U33960","U26413","U26414","U26415","U26416","U26417","U26418","U26419","U26436","U26468","U26469","U26470","U26471","U26472","U26473","U26474","U26475","U26476","U26477","U26478","U26479","U26480","U26481","U28649","U28650","U28651","U33961","U26420","U26421","U26422","U26423","U26424","U26437","U26440","U26441","U26442","U26443","U26444","U26445","U26446","U26447","U26448","U26449","U28652","U28653","U28654","U33963","U33967","U33968","U33969","U26427","U26428","U26429","U26430","U26431","U26432","U26433","U26438","U26439","U26452","U26453","U26454","U26455","U26456","U26457","U26458","U26459","U26460","U26461","U26462","U26463","U26464","U26465","U26466","U26467","U28655","U28656","U28657","U33962","N00801","N00803","N04107","N04110","N04117","N04123","N04139","N04150","N04159","N07800","N09040","N15040","N17023","N20805","N21806","N23804","N24015","N25027","N28027","N30020","N33023","N35030","N40013","N40014","N18004","N18005","N18008","N18020","N18100","N18703","N18704","N18705","N18719","N18820","N18899","N18902","N18905","N18909","N18912","N18915","N18928","N18929","N18930","N18931","N18932","N18933","N18934","N18935","N18938","N18939","N18940","N18941","N18942","N18953","N18954","N18963","N18964","N18980","N18981","N31004","N31006","N31008","N31805","N31806","N31848","N31849","N31857","N31858","N31859","N31860","N31861","N31862","N31863","N31864","N31865","N31866","N31867","N31868","N31869","N31870","N31871","N31872","N31873","N31874","N31875","N31876","N31877","N31878","N31879","N31880","N31881","N31885","N31886","N31887","N31888","N31889","N31890","N31891","N31910","U00800","U00801","U31004","U31402","U31462","U31463","U31505","U31801","U31803","U31804","N03008","N03009","N03010","N03011","N03012","N03013","N03014","N03035","N03036","N03038","N03039","N03041","N03042","N03043","N03044","N03045","N03046","N03047","N03049","N03051","N03052","N03053","N03054","N03055","N03056","N03057","N03058","N03059","N03060","N03061","N03062","N03063","N03107","N03108","N03111","N03125","N03126","N11038","N13032","N15045","N17001","N17030","N20029","N20900","N28016","N28018","N28021","N28026","N30001","N30026","U33750","U33751","U33752","U33753","U33754","U33755","U33756","U33757","U33758","U33759","U33760","U33761","U33762","U33763","U33764","U33765","U33766","U33767","U33768","U33769","U33770","U33771","U33772","U33773","U33774","U33775","U33776","U33777","U33778","U33779","U33780","U33781","U33782","U33783","U33784","U33785","U33786","U33787","U33788","U33789","U33790","U33791","N20048","N20897","N60077","N70060","N70465","N70815","N71007","U00205","U21340","U21426","U21454","U21463","U21481","U23421","U23482","U23495","U23505","U60977","U70447","U71453","U79029","U79092","U79133","N00097","N00901","N03034","N03102","N03103","N03105","N03109","N03112","N00528","N00529","N00530","N00531","N00532","N00533","N00534","N00535","N00536","N00544","N00545","N00546","N00547","N00548","N00549","N00550","N00551","N00552","N00553","N00556","N00557","N00558","N00559","N00561","N00562","N00563","N00572","N00573","N00574","N00576","N00577","N00578","N00586","N00587","N00588","N00589","N00590","N00591","N00592","N00593","N00594","N00595","N00596","N00597","N00598","N00604","N00605","N00606","N00607","N00608","N00609","N00610","N00611","N00612","N00613","N00614","N00615","N00616","N00617","N00618","N00619","N00620","N00621","N00622","N00623","N00624","N00625","N00626","N00627","N00628","N00629","N00630","N00631","N00632","N00633","N00634","N00635","N00636","N00637","N00638","N00640","N00641","N00646","N00647","N00649","N00650","N00651","N00652","N00653","N00654","N00655","N00656","N00657","N00658","N00659","N00660","N00661","N00662","N00664","N00665","N00666","N00668","N00670","N00095","N00096","N03066","N03067","N05002","N05010","N07036","N09100","N09102","N10037","N10038","N20001","N20011","N30005","N30101","N40007","N40008","N40010","N40011","N45030","N45031","N15559","N15600","N15607","N15608","N15609","N15610","N15611","N15612","N15614","N15616","N15617","N15619","N15620","N15621","N15622","N15624","N15625","N15626","N15627","N15628","N16010","N16011","N15535","N15630","N15637","N15639","N15640","N15641","N15642","N15644","N15646","N15647","N15649","N15650","N15651","N15652","N15654","N15655","N15656","N15657","N15658","N16020","N16021","N16003","N16004","N17650","N17660","N17664","N17667","N17668","N17669","N17670","N17671","N17672","N17674","N17676","N17677","N17679","N17680","N17681","N17682","N17684","N17685","N17686","N17687","N17688","N00673","N00674","N07918","N07919","N07920","N09810","N15325","N70466","N70467","N70550","N70551","N70552","N70553","N70555","N70556","N70557","N70558","N70559","N70560","N70561","N70562","N70563","N90001","N90002","N90003","N90004","N90005","N90006","N90007","U07340","U07341","U07342","U07343","U07344","U07345","U07346","U07347","U07348","U07349","U07350","U07351","U07353","U07354","U07355","U07356","U07358","U20341","U21341","U21342","U21343","U21345","U21346","U21347","U21348","U21349","U21350","U21351","U21352","U21353","U21355","U21356","U21357","U21358","U21359","U23340","U25340","U26341","U28341","U30341","U31341","U33341","U35341","U70443","U70444","N17300","N17301","N17302","N17303","N17304","N17305","N17306","N17307","N17308","N17309","N17310","N17311","N17312","N17313","N17314","N17315","N15140","N15300","N15301","N15302","N15303","N15304","N15305","N15306","N15307","N15308","N15309","N15310","N15311","N15312","N15313","N15314","N15315","N15316","N15317","N15318","N15319","N15320","N15321","N15322","N15323","N15324","N15326","N15327","N15328","N15329","N15330","N15331","N15332","N15333","N15334","N15335","N15336","N15337","N15338","N15339","N17140","N17330","N17331","N17332","N17333","N17334","N17335","N17336","N17337","N17338","N17339","N17340","N17341","N17342","N17343","N17344","N17345","N17346","N17347","N17348","N17349","N17350","N17351","N17352","N17353","N17354","N17355","N17356","N17357","N17358","N17359","N17360","N17361","N17362","N17363","N17364","N17365","N17366","N17367","N17368","N17369","N05403","N05404","N05801","N05802","N05803","N05804","N05805","N05806","N05807","N05808","N05809","N05810","N05811","N05812","N05813","N05814","N05815","N05817","N05818","N05819","N05820","N05821","N05822","N05823","N05824","N05826","N05827","N05828","N05829","N05830","N05832","N65841","N65842","N65843","N65844","N65845","N65846","N65847","N65848","N65849","N65851","N65852","N65853","N65854","N65855","N65856","N65857","N65858","N65859","N65870","N65871","N65872","N65873","N65874","U17410","U17413","U65860","U65861","U65862","U65863","U65864","U65865","U65866","U65867","U65868","U65869","U21447","U21449","U21455","U21461","U21462","U21464","U21465","U21466","U21467","U21468","U21470","U21471","U21472","U21473","U21474","U21475","U21477","U21478","U21482","U21504","U21505","U23448","U23450","U23459","U23460","U23461","U23462","U23463","U23464","U23465","U23466","U23467","U23468","U23469","U23470","U23471","U23472","U23473","U23474","U23475","U23480","U23481","U23483","U23484","U23506","U23508","U23509","U23516","U23520","U23521","U23590","U23591","U23592","U23593","U23594","U23595","N07600","N07601","N07602","N07603","N07604","N07605","N07606","N07607","N07608","N07609","N07610","N07611","N07612","N07613","N07614","N07615","N07616","N07617","N07618","N07619","N07620","N07621","N07622","N07623","N07624","N07625","N07626","N07627","N07628","N07629","N07630","N07631","N07632","N07633","N07634","N07635","N07636","N07637","N07638","N07639","N07640","N07641","N07642","N07643","N07644","N07645","N07646","N07647","N00954","N00980","N01712","N01717","N01813","N02004","N02957","N02958","N20007","N20402","N20403","N20891","N21006","N21009","N21022","N21023","N21024","N21025","N21026","N21701","N21702","N21706","N21804","N21814","N21817","N21818","N21826","N21827","N23005","N23006","N23009","N23700","N23805","N23809","U01421","U21200","U21401","U21425","U23200","U23401","U23420","U23433","U23489","U23490","U23493","U23494","U23701","N07540","N07541","N07542","N07543","N07544","N07546","N07547","N07548","U07417","U07452","N25017","N25021","N28008","N28009","N28011","N28012","N28013","N28015","N28037","N28801","N28802","N28804","N28805","N28811","N28812","N28813","N28814","N28815","N28816","N28817","N28818","N28819","N28820","N28821","N28891","U28563","U28564","U28565","U28568","U28569","U28570","U28616","U28619","U28622","U28634","N00906","N00959","N01451","N01452","N01454","N01455","N01456","N01458","N01460","N01464","N01481","N02013","N02923","N05400","N11023","N15813","N17457","U01415","U01424","U01434","U01471","U01472","U61901","N00221","N00942","N01801","N01802","N01804","N01805","N01812","N01817","N01926","N01953","N01954","N01956","N01957","N01961","N02006","N02820","N02822","N02829","N02832","N02833","N02834","N02835","N02836","N02837","N02838","N02839","N02840","N02841","N02842","N02843","N02844","N02845","N02846","N02847","N02909","N02910","N02911","N02913","N02914","N02924","N02938","N02993","U01805","N01984","N02901","N02903","N02942","N17473","N30206","N30209","N30214","N31001","N33001","N33802","N33816","N33817","N35001","U01804","U30200","U30452","U30751","U30752","U31001","U33401","U33580","U33594","U35400","U35543","N00217","N00220","N00485","N00486","N00700","N00701","N00702","N00703","N00704","N00705","N00706","N00707","N00708","N00960","N00961","N00962","N00963","N00964","N00991","N00994","N01803","N01806","N01955","N01964","N01976","N01986","N01987","N01990","N01991","N01992","N01993","N01995","N02002","N02896","N02925","N02926","N02995","N18406","N18407","N18408","N18409","N18410","N18411","N18413","N18701","N18801","N01921","N01927","N07960","N07961","N07963","N07965","N07966","N07968","N09009","N09013","N09101","N09103","N09206","N09209","N09214","N09701","N09801","N09805","N09806","N09807","N09808","N09809","N09811","N09817","N09887","N09888","N09891","N09892","U09200","U09700","U09701","U09702","U09703","U09705","U09706","U09707","U09708","U09709","U09710","U09711","U09712","U09714","U09715","U09716","U09717","U09718","U09719","U09720","U09721","U09806","U09819","U09820","U09824","U09825","U09836","U09837","U09843","U09844","U09848","U09849","U09850","U09851","U09852","U09853","U09854","U09855","U09856","U09857","U09863","U09864","U09868","U09869","U09870","U09871","U09884","U09885","U09886","U09904","U09905","U09906","U09907","U09908","U09909","U09910","U26490","U26491","U26492","U26493","U26494","U26495","U26496","U26497","U26498","U26499","U28617","U28618","U28620","U28621","U28623","U28624","U28625","U28626","U28627","U28628","U28629","U28630","U28631","U28632","U28633","U28635","U28636","U28637","U28638","U28639","U28640","U33965","U01901","U30453","N00957","N05833","N18500","U00200","U30447","U30448","U30449","U30450","U30451","U30900","U30901","U31500","U31501","U31502","U31503","U31504","U31506","U31902","U31903","U33575","U33576","U33577","U33578","U33579","U33581","U33589","U33590","U33591","U33592","U33593","U33595","U33900","U33901","U33903","U33904","U35538","U35539","U35540","U35541","U35542","U35544","U35900","U35901"]
API_URL_TEMPLATE = "https://api.kolada.se/v2/kpi/{}"
CSV_OUTPUT_FILE = "kpi_results.csv"  # Or provide a full path like "./output/kpi_results.csv"
LOG_FILE = "kpi_log.txt"

# Map JSON response fields to CSV column names
CSV_COLUMNS = ["concept", "name", "auspices", "description", "definition", "municipality_type", "is_divided_by_gender", "operating_area", "ou_publication_date", "perspective", "publication_date", "has_ou_data", "prel_publication_date"]

def fetch_kpi_data(kpi):
    """Fetch KPI data from the API and return the JSON response."""
    try:
        response = requests.get(API_URL_TEMPLATE.format(kpi))
        response.raise_for_status()  # Raise HTTPError for bad responses (4xx and 5xx)
        return response.json()
    except requests.exceptions.RequestException as e:
        print(f"Error fetching KPI {kpi}: {e}")
        return None

def process_kpi(kpi, writer, log_file):
    """Process a single KPI by fetching its data and writing to the CSV and log."""
    json_data = fetch_kpi_data(kpi)
    if not json_data:
        log_status(kpi, "error", log_file)
        return
    
    count = json_data.get("count", 0)
    if count == 0:
        log_status(kpi, "error: no data", log_file)
        print(f"Error: No data for KPI {kpi}")
    elif count > 1:
        log_status(kpi, "multiple choices", log_file)
        print(f"Error: Multiple choices for KPI {kpi}")
    else:
        values = json_data.get("values", [])[0]
        row = {
            "concept": values.get("id", ""),
            "name": values.get("title", ""),
            "auspices": values.get("auspices", ""),
            "description": values.get("description", ""),
            "definition": values.get("definition", ""),
            "municipality_type": values.get("municipality_type", ""),
            "is_divided_by_gender": values.get("is_divided_by_gender", ""),
            "operating_area": values.get("operating_area", ""),
            "ou_publication_date": values.get("ou_publication_date", ""),
            "perspective": values.get("perspective", ""),
            "publication_date": values.get("publication_date", ""),
            "has_ou_data": values.get("has_ou_data", ""),
            "prel_publication_date": values.get("prel_publication_date", "")
        }
        writer.writerow(row)
        log_status(kpi, "success", log_file)

def log_status(kpi, status, log_file):
    """Log the status of a KPI request in the log file."""
    log_file.write(f"{kpi}: {status}\n")

def main():
    # Create directory only if a directory is specified in the path
    if os.path.dirname(CSV_OUTPUT_FILE):
        os.makedirs(os.path.dirname(CSV_OUTPUT_FILE), exist_ok=True)

    # Open CSV file for writing
    with open(CSV_OUTPUT_FILE, mode='w', newline='', encoding='utf-8') as csv_file, open(LOG_FILE, mode='w') as log_file:
        # Create CSV writer and write header row
        writer = csv.DictWriter(csv_file, fieldnames=CSV_COLUMNS)
        writer.writeheader()

        # Process each KPI in the list
        for kpi in KPI_LIST:
            print(f"Processing KPI {kpi}...")
            process_kpi(kpi, writer, log_file)

    print("Processing completed. Check the log and CSV output.")

if __name__ == "__main__":
    main()
